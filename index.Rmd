---
output: 
  html_document:
    toc: true
    toc_float: true   



runtime: shiny


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(structtibble)
library(shiny)
library(truncnorm)
library(shiny)
library(reactable)
library(patchwork)
library(rhandsontable)

source("R/create_enums.R", encoding = "UTF-8")
source("R/simulator.R", encoding = "UTF-8")
source("R/game_simulation.R", encoding = "UTF-8")


```


# One Simulation


```{r, echo=FALSE}
#user inputs



inputPanel(
  
  numericInput(
    inputId = "total_steps",
    label = "Simulation steps",
    value = "500",
    step = 1
  ) ,
  numericInput(
    inputId = "prob_diligent",
    label = "Probability of Kludge when Diligent",
    value = "0.2",
    step = 0.01
  ) ,
  numericInput(
    inputId = "prob_kludgy",
    label = "Probability of Kludge when Kludgy",
    value = "0.8",
    step = 0.01
  ) ,

  numericInput(
    inputId = "prob_negative_when_correct_kludgy_accurate",
    label = "Probability of Negative when Correct Review of Kludgy PR and Accurate",
    value = "0.2",
    step = 0.01
  ) ,
  
  numericInput(
    inputId = "prob_negative_when_correct_not_kludgy_accurate",
    label = "Probability of Negative when Correct Review of Not Kludgy PR and Accurate",
    value = "0.2",
    step = 0.01
  ) ,

  numericInput(
    inputId = "prob_negative_when_incorrect_kludgy_accurate",
    label = "Probability of Negative when Incorrect Review of Kludgy PR and Accurate",
    value = "0.8",
    step = 0.01
  ) ,
  
  numericInput(
    inputId = "prob_negative_when_incorrect_not_kludgy_accurate",
    label = "Probability of Negative when Incorrect Review of Not Kludgy PR and Accurate",
    value = "0.8",
    step = 0.01
  ) ,

  
  numericInput(
    inputId = "prob_negative_when_correct_kludgy_inaccurate",
    label = "Probability of Negative when Correct Review of Kludgy PR and Inaccurate",
    value = "0.4",
    step = 0.01
  ) ,
  
  numericInput(
    inputId = "prob_negative_when_correct_not_kludgy_inaccurate",
    label = "Probability of Negative when Correct Review of Not Kludgy PR and Inaccurate",
    value = "0.2",
    step = 0.01
  ) ,

  numericInput(
    inputId = "prob_negative_when_incorrect_kludgy_inaccurate",
    label = "Probability of Negative when Incorrect Review of Kludgy PR and Inaccurate",
    value = "0.8",
    step = 0.01
  ) ,
  
  numericInput(
    inputId = "prob_negative_when_incorrect_not_kludgy_inaccurate",
    label = "Probability of Negative when Incorrect Review of Not Kludgy PR and Inaccurate",
    value = "0.9",
    step = 0.01
  ) ,
  
  
  
  numericInput(
    inputId = "mean_time_diligent",
    label = "Mean Time to Develop when Diligent",
    value = "5",
    step = "1"
  ) ,

  numericInput(
    inputId = "mean_time_kludgy",
    label = "Mean Time to Develop when Kludgy",
    value = "3",
    step = "1"
  ) ,

  numericInput(
    inputId = "sd_time_develop",
    label = "Stdev of Time to develop",
    value = "2",
    step = "1"
  ) ,

  
  numericInput(
    inputId = "mean_time_accurate",
    label = "Mean Time to Meta-review when Accurate",
    value = "2",
    step = "1"
  ) ,

  numericInput(
    inputId = "mean_time_inaccurate",
    label = "Mean Time to Meta-review when Inaccurate",
    value = "2",
    step = "1"
  ) ,
  

  numericInput(
    inputId = "sd_time_meta_review",
    label = "Stdev of Time to review",
    value = "0.5",
    step = "0.1"
  ) ,
  
  
  numericInput(
    inputId = "mean_time_review",
    label = "Mean Time to Review",
    value = "2",
    step = "1"
  ) ,

  numericInput(
    inputId = "sd_time_review",
    label = "SD time to review",
    value = "0.1",
    step = "1"
  ) ,

  
  numericInput(
    inputId = "prob_kludgy_review_when_kludge_careful",
    label = "Probability of Kludge Review when Kludge and Careful",
    value = "0.8"
  ) ,

  numericInput(
    inputId = "prob_kludgy_review_when_not_kludge_careful",
    label = "Probability of Kludge Review when No Kludge and Careful",
    value = "0.2"
  ) ,
    
  numericInput(
    inputId = "prob_kludgy_review_when_kludge_negligent",
    label = "Probability of Kludge Review when Kludge and Negligent",
    value = "0.6"
  ) ,

  numericInput(
    inputId = "prob_kludgy_review_when_not_kludge_negligent",
    label = "Probability of Kludge Review when No Kludge and Negligent",
    value = "0.2"
  ) ,
  

  selectInput(
    inputId = "action_d1",
    label = "Developer 1 Pure Strategy",
    choices = c("Diligent/Accurate", "Diligent/Innaccurate", "Kludgy/Accurate", "Kludgy/Innaccurate" )
  ) ,
  
  selectInput(
    inputId = "action_d2",
    label = "Developer 2 Pure Strategy",
    choices = c("Diligent/Accurate", "Diligent/Innaccurate", "Kludgy/Accurate", "Kludgy/Innaccurate" )
  ) ,
  
  selectInput(
    inputId = "action_r",
    label = "Reviewer Pure Strategy",  
    choices = c("Careful", "Negligent")
  ) ,
  
  numericInput(
    inputId = "prob_review",
    label = "Probability of a pull request to be reviewed",
    value = "0.3"
  ) ,
  
  numericInput(
    inputId = "prob_meta_review",
    label = "Probability of a review to be meta-reviewed",
    value = "0.3"
  ) ,
  

  numericInput(
    inputId = "time_penalty",
    label = "Time Penalty for caught Kludges",
    value = "0",
    step = 0.1
  ) ,
  
  numericInput(
    inputId = "entropy_factor",
    label = "Time Penalty for caught Kludges",
    value = "1.02",
    step = 0.01
  ) ,
    
  actionButton(
    inputId = "go",
    label = "GO!"
  )
  
  
)
```


```{r, echo=FALSE}
game_results <- eventReactive(eventExpr = input$go , valueExpr = {

  
  info <- list()
    
  values <- map(
    .x = names(input),
    .f = ~{info[[.x]] <- input[[.x]] }
  )
  
  browser()
  
  names(values) <- names(input)
  

  tictoc::tic("simulate")
  result <- simulate_game(values)
  tictoc::toc()
  
  result

})
  
  
  
```




```{r, echo=FALSE}

renderPlot({
  
  dados <- game_results() %>% 
    mutate(
      kludge = if_else(kludge == 1, "Kludge", "Not Kludge")
    )


  kludge_plot <- ggplot(dados) +
    geom_bar(
      aes(
        x = kludge,
        fill = kludge
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    )

  review_plot <- ggplot(dados) +
    geom_bar(
      aes(
        x = review_status,
        fill = review_status
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    )
    
  

  meta_review_plot <- ggplot(dados) +
    geom_bar(
      aes(
        x = meta_review_status,
        fill = meta_review_status
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    )
  
  pull_request_plot <- ggplot(dados) +
    geom_bar(
      aes(
        x = developer,
        fill = developer
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    ) 
  
  time_dist <- ggplot(dados) +
    geom_density(
      aes(
        x = time_to_develop
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 
    
  time_dist_d <- ggplot(dados) +
    geom_density(
      aes(
        x = time_to_develop,
        color = developer
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 

  
  cum_start_devs <- 
    dados %>% 
    arrange(start_time) %>% 
    group_by(
      developer
    ) %>% 
    mutate(
      unit = 1,
      cum_started_prs = cumsum(unit)
    ) %>% 
    ggplot() +
    geom_line(
      aes(
        x = start_time,
        y = cum_started_prs,
        color = developer
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 


  (kludge_plot | review_plot | meta_review_plot | pull_request_plot) / 
    (time_dist | time_dist_d | cum_start_devs )
  
  
  
  
},

height = 600
  
)


```




```{r, echo=FALSE}


renderReactable(
  reactable(game_results())
)


```


# Many Simulations


```{r, echo=FALSE}


possible_params <- read_rds("data/params.rds")

output$hot <- renderRHandsontable({
  
    DF = tibble(param = "total_steps", value = "500" )

    rhandsontable(DF, width = 550) %>%
        hot_col(col = "param", type = "dropdown", source = possible_params )
    
    
    
  })


inputPanel(
  
  verticalLayout(
    rHandsontableOutput("hot", width = 600, height = 600)  ,
    actionButton(inputId = "gotable",  label = "Go!")
  )
  
)



renderReactable({
  
    input$gotable
    hot = isolate(input$hot)
    if (!is.null(hot)) {
      
      reactable(hot_to_r(input$hot))
      
    }  
  
})






```











