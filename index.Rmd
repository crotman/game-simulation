---
output: html_document

runtime: shiny


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(structtibble)
library(shiny)
library(truncnorm)
library(shiny)
library(reactable)
library(patchwork)
library(rhandsontable)
library(scales)

source("R/create_enums.R", encoding = "UTF-8")
source("R/simulator.R", encoding = "UTF-8")
source("R/game_simulation.R", encoding = "UTF-8")
source("R/simmer.R", encoding = "UTF-8")

future::plan(future::multiprocess)


```


# One Simulation


```{r, echo=FALSE}
#user inputs



"Developers" %>% h4()
inputPanel(
  rHandsontableOutput("devs", width = 600, height = 150)  
)


"Reviewers"  %>% h4()
inputPanel(
  rHandsontableOutput("revs", width = 600, height = 150)
)



output$devs <- renderRHandsontable({

    DF = tibble(
      strategy_dev = c(actions$Diligent, actions$Diligent),
      strategy_meta = c(actions$Accurate, actions$Accurate )
    )

    rhandsontable(DF, width = 550) %>%
        hot_col(
          col = "strategy_dev",
          type = "dropdown",
          source = c(actions$Diligent, actions$Kludgy)  
        ) %>% 
        hot_col(
          col = "strategy_meta",
          type = "dropdown",
          source = c(actions$Accurate, actions$Inaccurate)  
        ) 

  })


output$revs <- renderRHandsontable({

    DF = tibble(
      strategy_rev = c(actions$Careful, actions$Careful ),
    )

    rhandsontable(DF, width = 550) %>%
        hot_col(
          col = "strategy_rev",
          type = "dropdown",
          source = c(actions$Careful, actions$Negligent)  
        ) 

  })


"Game" %>%  h4()


inputPanel(
      numericInput(
        inputId = "total_steps",
        label = "$$Steps$$" %>% withMathJax(),
        value = "5000",
        step = 1
      ), 
      
      numericInput(
        inputId = "entropy_factor",
        label = "$$H$$" %>% withMathJax(),
        value = "1.02",
        step = 0.01
      ) ,

      numericInput(
        inputId = "prob_review",
        label = "$$P(Review)$$" %>% withMathJax(),
        value = "0.33"
      ) ,
      
      numericInput(
        inputId = "prob_meta_review",
        label = "$$P(MetaReview|Review)$$"  %>% withMathJax(),
        value = "0.5"
      ) ,
      
      numericInput(
        inputId = "lambda",
        label = "$$\\lambda$$"  %>% withMathJax(),
        value = "0.1"
      ) 
      

      
)

"Development Stage"  %>% h4()

"(D = Diligent, K = Kludge/Kludgy, R = Reworking)" %>% HTML()

inputPanel(
      numericInput(
        inputId = "prob_diligent",
        label = "$$P(K)|D$$" %>%  withMathJax(),
        value = "0.15",
        step = 0.01
      ) ,
      numericInput(
        inputId = "prob_kludgy",
        label = "$$P(K)|K$$" %>%  withMathJax(),
        value = "0.85",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "mean_time_diligent",
        label = withMathJax("$$\\mu|(D, !R)$$"),
        value = "10",
        step = "1"
      ) ,
    
      numericInput(
        inputId = "mean_time_kludgy",
        label = withMathJax("$$\\mu|(K, !R)$$"),
        value = "6",
        step = "1"
      ) ,
    
      numericInput(
        inputId = "sd_time_develop",
        label = withMathJax("$$\\sigma|(!R)$$"),
        value = "2",
        step = "1"
      ) ,

      numericInput(
        inputId = "mean_time_rework",
        label = withMathJax("$$\\mu|R$$"),
        value = "3",
        step = "1"
      ) ,

      numericInput(
        inputId = "sd_time_rework",
        label = withMathJax("$$\\sigma|R$$"),
        value = "5",
        step = "1"
      ) 

)


"Review Stage"  %>% h4()

"(K = Kludge, C = Careful, N = Negligent)" %>% HTML()

inputPanel(

      
      numericInput(
        inputId = "mean_time_review",
        label = "$$\\mu$$",
        value = "1",
        step = "1"
      ) ,
    
      numericInput(
        inputId = "sd_time_review",
        label = "$$\\sigma$$",
        value = "0.2",
        step = "1"
      ) ,
    
      
      numericInput(
        inputId = "prob_kludgy_review_when_kludge_careful",
        label = "$$P(K)|(K, C)$$" %>% withMathJax() ,
        value = "0.85"
      ) ,
    
      numericInput(
        inputId = "prob_kludgy_review_when_not_kludge_careful",
        label = "$$P(K)|(!K, C)$$" %>% withMathJax(),
        value = "0.1"
      ) ,
        
      numericInput(
        inputId = "prob_kludgy_review_when_kludge_negligent",
        label = "$$P(K)|(K, N)$$" %>% withMathJax(),
        value = "0.4"
      ) ,
    
      numericInput(
        inputId = "prob_kludgy_review_when_not_kludge_negligent",
        label = "$$P(K)|(!K, N)$$" %>% withMathJax(),
        value = "0.1"
      ) 
)
      
"Metareview Stage"  %>% h4()

"(K = Kludge, A = Accurate, I = Innacurate, + = Good Review/Correct Review,  - = Bad Review/Incorrect Review)" %>%  HTML()

inputPanel(

      numericInput(
        inputId = "prob_negative_when_correct_kludgy_accurate",
        label = "$$P(-)|(K, +, A)$$" %>%  withMathJax(),
        value = "0.1",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "prob_negative_when_correct_not_kludgy_accurate",
        label = "$$P(-)|(!K, +, A)$$"  %>%  withMathJax(),
        value = "0.1",
        step = 0.01
      ) ,
    
      numericInput(
        inputId = "prob_negative_when_incorrect_kludgy_accurate",
        label = "$$P(-)|(K, -, A)$$"  %>%  withMathJax(),
        value = "0.85",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "prob_negative_when_incorrect_not_kludgy_accurate",
        label = "$$P(-)|(!K, -, A)$$"  %>%  withMathJax(),
        value = "0.85",
        step = 0.01
      ) ,
    
      
      numericInput(
        inputId = "prob_negative_when_correct_kludgy_inaccurate",
        label = "$$P(-)|(K, +, I)$$"  %>%  withMathJax(),
        value = "0.4",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "prob_negative_when_correct_not_kludgy_inaccurate",
        label = "$$P(-)|(!K, +, I)$$"  %>%  withMathJax(),
        value = "0.1",
        step = 0.01
      ) ,
    
      numericInput(
        inputId = "prob_negative_when_incorrect_kludgy_inaccurate",
        label = "$$P(-)|(K, -, I)$$"  %>%  withMathJax(),
        value = "0.1",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "prob_negative_when_incorrect_not_kludgy_inaccurate",
        label = "$$P(-)|(!K, -, I)$$"  %>%  withMathJax(),
        value = "0.9",
        step = 0.01
      ) ,
      
      numericInput(
        inputId = "mean_time_accurate",
        label = "$$\\mu|A$$"  %>%  withMathJax() ,
        value = "1",
        step = "1"
      ) ,
    
      numericInput(
        inputId = "mean_time_inaccurate",
        label = "$$\\mu|I$$"  %>%  withMathJax(),
        value = "1",
        step = "1"
      ) ,
      
    
      numericInput(
        inputId = "sd_time_meta_review",
        label = "$$\\sigma$$"  %>%  withMathJax(),
        value = "0.2",
        step = "0.1"
      ) 

)


  actionButton(
    inputId = "go",
    label = "GO!"
  )

```


```{r, echo=FALSE}
game_results <- eventReactive(eventExpr = input$go , valueExpr = {

  
  info <- list()
    
  values <- map(
    .x = names(input),
    .f = ~{
      if(.x %in% c("devs", "revs")){
        info[[.x]] <- hot_to_r(input[[.x]])
      } else{
        info[[.x]] <- input[[.x]]   
      }
      
    }
  )

  names(values) <- names(input)


  simulate_and_label <- function(round, values){
    
    simulated <- simulate_game_simmer(values)
    
    # saida <- list(
    #   data = simulated$data %>% 
    #     mutate(
    #       round = round
    #     ),
    #   
    #   entropy = simulated$entropy %>% 
    #     mutate(
    #       round = round
    #     )
    # )
    
    saida

  }
  
  browser()
  
  tictoc::tic("tudo")
  result <- furrr::future_map(
    .x = 1:30,
    .f = ~simulate_and_label(round = .x, values = values),
    .progress = TRUE
  )
  tictoc::toc()

  result

})
  
  
  
```




```{r, echo=FALSE}

renderPlot({
  

  
  data <- game_results()$data


  merges_kludge <- data %>% 
    filter(
      kludge %in% c(0,1)      
    ) %>% 
    group_by(
      pullrequest, rework
    ) %>% 
    summarise(
      kludge = mean(kludge)
    ) %>% 
    mutate(
      kludge = if_else(kludge == 1, "Kludge", "Not Kludge")
    )
  
  kludge_plot <- ggplot(merges_kludge) +
    geom_bar(
      aes(
        x = kludge,
        fill = kludge
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle(
      label = "Kludge/Not Kludge Merged"
    )

  
  review_statuses <- data %>% 
    group_by(
      pullrequest, rework
    ) %>% 
    summarise(
      to_be_reviewed = max(to_be_reviewed, na.rm = TRUE)
    ) %>% 
    mutate(
      to_be_reviewed = if_else(to_be_reviewed == 1, "Reviewed", "Not Reviewed")
    )
    
    
  
  
  review_plot <- ggplot(review_statuses) +
    geom_bar(
      aes(
        x = to_be_reviewed,
        fill = to_be_reviewed
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    ) + ggtitle("Reviewed/Not Reviewed PRs")
    
  meta_review_statuses <- data %>% 
    group_by(
      pullrequest, rework
    ) %>% 
    summarise(
      to_be_metareviewed = max(to_be_metareviewed, na.rm = TRUE)
    ) %>% 
    mutate(
      to_be_metareviewed = if_else(to_be_metareviewed == 1, "MetaReviewed", "Not MetaReviewed")
    ) 
  

  meta_review_plot <- ggplot(meta_review_statuses) +
    geom_bar(
      aes(
        x = to_be_metareviewed,
        fill = to_be_metareviewed
      ),
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    )+ ggtitle("MetaReviewed/Not MetaReviewed PRs")
  
  merges_developer <- data %>% 
    filter(
      merged == 1
    ) %>% 
    group_by(
      developer
    ) 

  
  pull_request_plot <- ggplot(merges_developer) +
    geom_bar(
      aes(
        x = developer,
        fill = factor(developer)
      )
    ) +
    theme_minimal() +
    scale_x_discrete() + 
    theme(
      legend.position = "top",
      axis.text.x = element_text(angle = 90)
    ) + ggtitle("Merges by developer")
  
  time_to_develop <- data %>% 
    group_by(
      pullrequest, developer
    ) %>% 
    summarise(
      end = weighted.mean(x = time, w = !is.na(merged) , na.rm = TRUE),
      begin = min(time, na.rm = TRUE)
    ) %>% 
    mutate(
      time_to_develop = end - begin
    )
  
  time_dist <- ggplot(time_to_develop) +
    geom_density(
      aes(
        x = time_to_develop
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 
    
  time_dist_d <- ggplot(time_to_develop) +
    geom_density(
      aes(
        x = time_to_develop,
        color = factor(developer)
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 

  
  
  cum_merged_devs <- 
    time_to_develop %>% 
    arrange(end) %>% 
    group_by(
      developer
    ) %>% 
    mutate(
      unit = 1,
      cum_merged_prs = cumsum(unit)
    ) %>% 
    ggplot() +
    geom_line(
      aes(
        x = end,
        y = cum_merged_prs,
        color = factor(developer)
      ),
      size = 1
    ) +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 


  

  
  time_to_develop_time <- ggplot(time_to_develop,
                                aes(
        x = begin,
        y = time_to_develop,
        color = factor(developer)
                                  
                                )
                                
                                ) +
    geom_point(
        alpha = 0.3
    ) +
    geom_smooth() +
    theme_minimal() +
    theme(
      legend.position = "top"
    ) 
    
  



  
  (kludge_plot | review_plot | meta_review_plot | pull_request_plot) / 
    (time_dist | time_dist_d | time_to_develop_time | cum_merged_devs )
  
  
  
  
},

height = 600
  
)


```



```{r, echo=FALSE}

# renderPlot({
# 
#   data <- game_results()$data
# 
# 
#   max_start = max(data$time)
#   
#   trajectories <- data %>% 
#     dplyr::select(
#       time,
#       pullrequest,
#       cur_stage,
#       rework,
#       phase
#     ) %>% 
#     group_by(
#       pullrequest
#     ) %>% 
#     mutate(
#       start_pr = min(time)
#     ) %>% 
#     pivot_wider(
#       names_from = phase,
#       values_from = time
#     ) %>% 
#     janitor::clean_names() %>% 
#     replace_na(
#       list(end = max_start)
#     )
#     
#     ggplot(trajectories) +
#       geom_segment(
#         aes(
#           y = start_pr,
#           yend = start_pr,
#           x = start - start_pr,
#           xend = end - start_pr,
#           color = cur_stage
#         )
#         
#       )
#   
# },
# 
# height = 800
# 
# )


```








```{r, echo=FALSE}


# renderReactable(
#   reactable(game_results()$data)
# )


```


# Many Simulations


```{r, echo=FALSE}


possible_params <- read_rds("data/params.rds")

output$hot <- renderRHandsontable({
  
    DF = tibble(param = "total_steps", value = "500" )

    rhandsontable(DF, width = 550) %>%
        hot_col(col = "param", type = "dropdown", source = possible_params )

  })


inputPanel(
  
  verticalLayout(
    rHandsontableOutput("hot", width = 600, height = 600)  ,
    actionButton(inputId = "gotable",  label = "Go!")
  )
  
)


renderReactable({
  
    input$gotable
    hot = isolate(input$hot)
    if (!is.null(hot)) {
      reactable(hot_to_r(input$hot))
    }  
  
})





```







